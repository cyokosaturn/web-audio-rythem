!function(n){function r(){for(var n=arguments[0],r=1;r<arguments.length;r++){var t=arguments[r];for(var e in t)n[e]=t[e]}return n}function t(n,r,t){return n.reduce(function(n,t,e,u){return n[t[r]]=t,n},t||{})}window.Ut={extend:r,arrayToJson:t}}(window);
!function(){navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,window.URL=window.URL||window.webkitURL||window.mozURL||window.msURL,window.AudioContext=window.AudioContext||window.webkitAudioContext}();
!function(o){function n(o){this.config={audioContext:o,audioBuffers:{},audioInfo:{}}}function i(o,n,i){var u=this,e=u.config;return new Promise(function(u){return e.audioBuffers[o]?void u(e.audioBuffers[o]):f.loadAudioBuffer(e.audioContext,n).then(function(n){e.audioBuffers[o]=n,e.audioInfo[o]=i,u(n)})})}function u(o,n,i){var u=this,e=u.config;e.audioBuffers[o]=n,e.audioInfo[o]=i}function e(){return this.config.audioBuffers}function t(o,n){var i=function(i,u){o.decodeAudioData(i,function(o){return o?void u(o):void alert("error decoding file data: "+n)},function(o){alert("decodeAudioData error",o)})},u=function(o){var i=new XMLHttpRequest;i.open("GET",n,!0),i.responseType="arraybuffer",i.onload=function(){o(i.response)},i.send()};return new Promise(function(o,n){u(function(n){i(n,function(n){o(n)})})})}var f=o.AudioHelper=function(){this.init.apply(this,Array.prototype.slice.call(arguments))};f.prototype={init:n,loadAudioBuffer:i,setAudioBuffer:u,getAudioBuffers:e},f.loadAudioBuffer=t}(window);
!function(o){function e(){for(var o=arguments[0],e=1;e<arguments.length;e++){var t=arguments[e];for(var n in t)o[n]=t[n]}return o}function t(o,t){var n=this,r=n.config=e({},u.defauts,t);r.context=o,r.gain=r.context.createGain(),r.convolver=r.context.createConvolver(),r.gain.connect(r.convolver),r.convolver.connect(r.context.destination),n.setParam()}function n(o){var t=this.config.effectSoundId,n=this,r=n.config=e(n.config,o||{});r.audioBuffers&&r.effectSoundId!=t&&(r.convolver.buffer=r.audioBuffers[r.effectSoundId])}function r(){var o=this,e=o.config;e.loop=e.loop-e.preScheduleLoop,e.bufferSources.forEach(function(o){o.loop>=e.loop&&o.bufferSource.stop()})}function c(){var o=this,e=o.config,t=e.context.currentTime;e.loop=0,e.isPlaying=!0,e.bufferSources=[];var n=function(){for(var o=0;o<e.beat;o++)e.score.forEach(function(n,r){if(n.pattern[o]){var c=e.context.createBufferSource();c.buffer=e.audioBuffers[n.soundId],c.connect(e.gain),c.start(.1+t+(o+e.loop*e.beat)/4*(60/e.tempo)),e.bufferSources.push({loop:e.loop,bufferSource:c}),c.onended=function(){e.bufferSources.shift()}}});e.loop++,console.log(e.bufferSources.length,e.loop)},r=function(){e.timer=setTimeout(function(){e.context.currentTime-t>=(e.loop-e.preScheduleLoop)*e.beat/4*(60/e.tempo)&&n(),r()},0)};r()}function f(){var o=this,e=o.config;e.isPlaying&&(e.isPlaying=!1,e.bufferSources.forEach(function(o){o.bufferSource.stop()}),e.bufferSources=[],clearTimeout(e.timer))}var u=o.Audio=function(){this.init.apply(this,Array.prototype.slice.call(arguments))};u.prototype={init:t,setParam:n,chancelPlaySchedule:r,playScore:c,stopScore:f},u.defauts={preScheduleLoop:3,beat:16,tempo:80,bufferSources:[]}}(window);
!function(e){function r(){for(var e=arguments[0],r=1;r<arguments.length;r++){var t=arguments[r];for(var n in t)e[n]=t[n]}return e}function t(e,t){var n=this,o=n.config=r({},f.defauts,t);o.context=e}function n(){var e=this,r=e.config;return new Promise(function(e,t){r.stream?e(r.stream):navigator.getUserMedia({video:!1,audio:!0},function(r){e(r)},function(e){console.log(e.name?e.name:e)})})}function o(){var e=this,r=e.config;e.getStream().then(function(e){r.stream=e,r.audioBufferArray=[];var t=r.context.createMediaStreamSource(r.stream),n=r.context.createAnalyser();r.scriptProcessor=r.context.createScriptProcessor(r.bufferSize,1,1),r.scriptProcessor.onaudioprocess=function(e){var t=function(){var e=0,r=new Uint8Array(n.frequencyBinCount);n.getByteFrequencyData(r);for(var t=0;t<r.length;t++)e+=r[t];return e},o=function(){for(var t=e.inputBuffer.getChannelData(0),n=new Float32Array(r.bufferSize),o=0;o<r.bufferSize;o++)n[o]=t[o];r.audioBufferArray.push(n)};t()>=r.detectionMinVolume&&o()},t.connect(n),n.connect(r.scriptProcessor),r.scriptProcessor.connect(r.context.destination)})}function i(){var e=this,r=e.config;!r.scriptProcessor||r.scriptProcessor.disconnect(),r.stream&&(r.stream.stop(),r.stream=null)}function c(e){for(var r=this,t=r.config,n=t.context.createBuffer(1,e.length*t.bufferSize,t.context.sampleRate),o=n.getChannelData(0),i=0;i<e.length;i++)for(var c=0;c<t.bufferSize;c++)o[i*t.bufferSize+c]=e[i][c];return n}function a(){var e=this,r=e.config;return e.convertToAudioBuffer(r.audioBufferArray)}var f=e.Recorder=function(){this.init.apply(this,Array.prototype.slice.call(arguments))};f.prototype={init:t,getStream:n,recording:o,stopRecording:i,convertToAudioBuffer:c,getAudioBuffer:a},f.defauts={bufferSize:4096,detectionMinVolume:1e4}}(window);
!function(e){function o(e){var o=this,t=o.config=Ut.extend({},d.defauts,e||{});t.audioContext=new AudioContext,t.audioHelper=new AudioHelper(t.audioContext),t.sts={nowScoreId:t.nowScoreId||t.scoreSet[0].id,nowEffectSoundId:t.nowEffectSoundId||t.effectSoundSource[0].id,tempo:t.tempo,nowRecording:!1,autoVoiceNo:1},t.view=new d.View({app:o}),t.view.renderInfoUi(),t.view.renderScoreSection(),t.view.config.el.message.textContent="now loading...",o.getAudioBuffers(function(e){t.view.config.el.message.textContent="",t.audio=new Audio(t.audioContext,{audioBuffers:e}),o.setupAudioParam(),t.recorder=new Recorder(t.audioContext),o.control()})}function t(e){var o=this,t=o.config;Promise.all(t.soundSource.concat(t.effectSoundSource).map(function(e){return e.url?t.audioHelper.loadAudioBuffer(e.id,e.url):e.buffer?t.audioHelper.setAudioBuffer(e.id,e.buffer):void 0})).then(function(){!e||e.call(o,t.audioHelper.getAudioBuffers())})}function n(){var e=this,o=e.config;o.audio.setParam({effectSoundId:o.sts.nowEffectSoundId,score:e.getNowScore().score,tempo:o.sts.tempo}),o.audio.chancelPlaySchedule()}function r(){var e=this,o=e.config;return Ut.arrayToJson(o.scoreSet,"id")[o.sts.nowScoreId]}function i(e,o){var t=this,n=t.config;n.soundSource.push({id:e,buffer:o}),t.getAudioBuffers()}function c(){var e=this,o=e.config;e.setupAudioParam(),o.audio.playScore(),o.view.config.el.playBtn.textContent="STOP"}function u(){var e=this,o=e.config;o.audio.stopScore(),o.view.config.el.playBtn.textContent="PLAY"}function a(){var e=this,o=e.config;"click change".split(" ").forEach(function(o){document.body.addEventListener(o,function(o){for(var n in t)o.target.classList.contains(n)&&t[n].call(e,o)},!1)});var t={};t.tempo=function(t){"change"==t.type&&(o.sts.tempo=t.target.value,e.setupAudioParam())},t.scoreSelector=function(t){"change"==t.type&&(o.sts.nowScoreId=t.target.value,o.view.renderScoreSection(),e.setupAudioParam())},t.effectSoundSelector=function(t){"change"==t.type&&(o.sts.nowEffectSoundId=t.target.value,e.setupAudioParam())},t.playBtn=function(t){if("click"==t.type){if(o.sts.nowRecording)return;o.audio.config.isPlaying?e.playStop():e.playStart()}},t.part__soundId=function(t){"change"==t.type&&(e.getNowScore().score=o.view.getScoreData(),e.setupAudioParam())},t.score__attack=function(t){"change"==t.type&&(e.getNowScore().score=o.view.getScoreData(),e.setupAudioParam())},t.recBtn=function(t){if("click"==t.type)for(var n=document.querySelectorAll(".part"),r=0;r<n.length;r++)!function(r){var i=n.item(r);if(i.querySelector(".recBtn")==t.target)if(o.sts.nowRecording){o.sts.nowRecording=!1,o.recorder.stopRecording(),t.target.textContent="REC";var c="voice"+o.sts.autoVoiceNo++;e.addSourceBuffer(c,o.recorder.getAudioBuffer()),e.getNowScore().score[r].soundId=c,o.view.renderScoreSection(),e.playStart()}else e.playStop(),o.sts.nowRecording=!0,o.recorder.recording(),t.target.textContent="REC FINISH & PLAY"}(r)}}var d=e.App=function(){this.init.apply(this,Array.prototype.slice.call(arguments))};d.prototype={init:o,getAudioBuffers:t,setupAudioParam:n,getNowScore:r,addSourceBuffer:i,playStart:c,playStop:u,control:a},d.defauts={tempo:80,beat:16,soundSource:[],effectSoundSource:[],scoreSet:[]}}(window);
!function(e){function t(e){var t=this,o=t.config=Ut.extend({},e||{});o.el={message:document.querySelector(".message"),playBtn:document.querySelector(".playBtn"),scoreSelector:document.querySelector(".scoreSelector"),effectSoundSelector:document.querySelector(".effectSoundSelector"),tempo:document.querySelector(".tempo"),part__template:document.querySelector(".part__template"),l_part:document.querySelector(".l_part")}}function o(){var e=this,t=e.config,o=t.el;t.app.config.scoreSet.forEach(function(e,r){var c=document.createElement("option");c.textContent=e.id,e.id==t.app.config.sts.nowScoreId&&(c.selected=!0),o.scoreSelector.appendChild(c)}),t.app.config.effectSoundSource.forEach(function(e,r){var c=document.createElement("option");c.textContent=e.id,e.id==t.app.config.sts.nowEffectSoundId&&(c.selected=!0),o.effectSoundSelector.appendChild(c)}),o.tempo.value=t.app.config.sts.tempo}function r(){var e=this,t=e.config,o=t.el;o.l_part.innerHTML="",t.app.getNowScore().score.forEach(function(e,r){var c=o.part__template.cloneNode(!0);c.classList.remove("part__template"),c.classList.add("part"),o.l_part.appendChild(c),t.app.config.soundSource.forEach(function(t){var o=document.createElement("option");o.textContent=t.id,e.soundId==t.id&&(o.selected=!0),c.querySelector(".part__soundId").appendChild(o)});for(var r=0;r<t.app.config.beat/4-1;r++)c.querySelector(".score__section").appendChild(c.querySelector(".score__attack").cloneNode(!0));for(var r=0;3>r;r++)c.querySelector(".score").appendChild(c.querySelector(".score__section").cloneNode(!0));for(var n=c.querySelectorAll(".score__attack"),r=0;r<n.length;r++)e.pattern[r]&&(n.item(r).checked=!0)})}function c(){for(var e=this,t=(e.config,e.el,[]),o=document.querySelectorAll(".part"),r=0;r<o.length;r++){var c={},n=o.item(r);c.soundId=n.querySelector(".part__soundId").value;for(var a=[],l=n.querySelectorAll(".score__attack"),p=0;p<l.length;p++){var i=l.item(p);a.push(i.checked?1:0)}c.pattern=a,t.push(c)}return t}var n=e.App;n.View=function(){this.init.apply(this,Array.prototype.slice.call(arguments))},n.View.prototype={init:t,renderInfoUi:o,renderScoreSection:r,getScoreData:c}}(window);
!function(){var n=[{id:"piano",url:"sound/piano_c.wav"},{id:"base",url:"sound/base13.wav"},{id:"snare",url:"sound/snare.wav"},{id:"hihat",url:"sound/hihat.wav"},{id:"kick",url:"sound/kick.wav"}],a=[{id:"underground_car_park",url:"sound/ir/underground_car_park.wav"},{id:"maes_howe",url:"sound/ir/maes_howe.wav"},{id:"hamilton_mausoleum",url:"sound/ir/hamilton_mausoleum.wav"}],d=[{id:"pattern_1",score:[{soundId:"hihat",pattern:[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0]},{soundId:"snare",pattern:[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0]},{soundId:"kick",pattern:[1,0,0,0,0,0,0,0,1,0,1,0,0,0,0,0]}]},{id:"pattern_2",score:[{soundId:"hihat",pattern:[1,1,1,0,1,0,1,0,1,0,1,0,1,0,1,0]},{soundId:"snare",pattern:[0,0,0,0,1,0,0,0,0,0,0,0,1,1,0,1]},{soundId:"kick",pattern:[1,0,0,0,0,0,0,0,1,1,1,0,0,0,1,0]}]},{id:"pattern_3",score:[{soundId:"hihat",pattern:[1,0,0,0,0,0,0,0,1,0,1,0,1,0,1,0]},{soundId:"snare",pattern:[1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1]},{soundId:"kick",pattern:[1,0,0,0,0,0,0,0,1,0,1,0,0,1,1,0]},{soundId:"base",pattern:[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]}]}];new App({tempo:130,soundSource:n,effectSoundSource:a,scoreSet:d})}();